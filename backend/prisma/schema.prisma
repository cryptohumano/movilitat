// ===========================================
// RUTA-CHECK - Schema de Base de Datos
// Sistema de digitalización de transporte público
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum Role {
  SUPER_ADMIN    // Administrador del sistema (tú)
  ADMIN_EMPRESA  // Gerente/dueño de empresa de transporte
  CHECADOR       // Persona en punto de control
  CHOFER         // Conductor del vehículo
  PASAJERO       // Usuario de transporte público (suscrito a rutas)
}

enum TipoVehiculo {
  AUTOBUS
  MICROBUS
  COMBI
}

enum EstadoVehiculo {
  ACTIVO
  INACTIVO
  MANTENIMIENTO
  BAJA
}

enum EstadoCheckIn {
  PENDIENTE      // Check-in registrado, pago pendiente
  PAGADO         // Pago confirmado
  CANCELADO      // Cancelado por algún motivo
}

enum TipoPago {
  CHECKIN        // Pago por check-in ($15/día)
  SUSCRIPCION    // Pago mensual empresa ($500-1000/derrotero)
  INCENTIVO      // Incentivo al checador
}

enum EstadoPago {
  PENDIENTE
  COMPLETADO
  FALLIDO
  REEMBOLSADO
}

// Estadísticas de unidad: km, servicios, deterioros (compartido admin + chofer)
enum TipoRegistroUnidad {
  KM         // Kilometraje (valor numérico)
  SERVICIO   // Servicio/mantenimiento (descripción)
  DETERIORO  // Deterioro/falla (descripción)
}

// ===========================================
// USUARIOS Y AUTENTICACIÓN
// ===========================================
// Jerarquía:
// - SUPER_ADMIN: plataforma; cobra a las empresas (modelo SaaS).
// - ADMIN_EMPRESA (gerente): pertenece a UNA empresa; lo crea Super Admin
//   (o otro gerente de la misma empresa). Es el "admin de esa empresa".
// - CHOFER / CHECADOR: pueden trabajar en DIFERENTES empresas/derroteros;
//   su ámbito se define por ASIGNACIONES (vehículos, puntos de control), no
//   por un único empresaId. User.empresaId para ellos es opcional (ej. empresa principal).
// - PASAJERO: usuario final, sin empresa.
//

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  telefono      String    @unique
  password      String
  nombre        String
  apellido      String?
  role          Role      @default(CHOFER)
  activo        Boolean   @default(true)
  avatar        String?
  
  // Solo obligatorio para ADMIN_EMPRESA (gerente). Opcional para CHOFER/CHECADOR
  // (empresa "principal"; el ámbito real viene de vehículos/puntos asignados).
  empresaId     String?
  empresa       Empresa?  @relation(fields: [empresaId], references: [id])
  
  // Relaciones específicas
  chofer        Chofer?
  checador      Checador?
  suscripcionesRuta SuscripcionRuta[]

  // Auditoría
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?

  @@index([telefono])
  @@index([role])
  @@map("users")
}

// ===========================================
// EMPRESAS DE TRANSPORTE
// ===========================================

model Empresa {
  id                String       @id @default(cuid())
  codigo            String       @unique // E01, E02, etc.
  nombre            String
  nombreCorto       String?      // "Ruta 25", "Ruta 27", etc.
  razonSocial       String?
  rfc               String?
  
  // Contacto
  direccion         String?
  telefono          String?
  email             String?
  
  // Configuración de negocio
  precioMensualDerrotero Decimal?  @db.Decimal(10, 2) // $500-1000 por derrotero
  activa            Boolean      @default(true)
  
  // Estadísticas precalculadas
  totalVehiculos    Int          @default(0)
  totalDerroteros   Int          @default(0)
  
  // Relaciones
  usuarios          User[]
  derroteros        Derrotero[]
  vehiculos         Vehiculo[]
  pagos             Pago[]
  
  // Auditoría
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([codigo])
  @@map("empresas")
}

// ===========================================
// DERROTEROS (RUTAS)
// ===========================================

model Derrotero {
  id              String         @id @default(cuid())
  numero          Int            // Número dentro de la empresa (1, 2, 3...)
  nombre          String         // Descripción de la ruta
  
  // Empresa propietaria
  empresaId       String
  empresa         Empresa        @relation(fields: [empresaId], references: [id])
  
  // Parque vehicular asignado
  autobuses       Int            @default(0)
  microbuses      Int            @default(0)
  combis          Int            @default(0)
  totalVehiculos  Int            @default(0)
  
  // Puntos de control en esta ruta
  puntosControl   PuntoControl[]
  vehiculos       Vehiculo[]
  registrosRutaChofer RegistroRutaChofer[]
  
  // Horarios de operación (para pasajeros)
  horarioInicio   String?       // "06:00"
  horarioFin      String?       // "22:00"
  
  // Estado
  activo          Boolean        @default(true)
  
  // Suscripciones de pasajeros
  suscripciones   SuscripcionRuta[]
  
  // Auditoría
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([empresaId, numero])
  @@index([empresaId])
  @@map("derroteros")
}

// ===========================================
// PUNTOS DE CONTROL
// ===========================================

model PuntoControl {
  id              String        @id @default(cuid())
  nombre          String        // "Calacoaya", "Metro Rosario", etc.
  descripcion     String?
  
  // Ubicación
  latitud         Decimal?      @db.Decimal(10, 8)
  longitud        Decimal?      @db.Decimal(11, 8)
  direccion       String?
  
  // Opcional: parada de referencia (ej. datos CDMX WiFi) para usar coordenadas
  paradaReferenciaId String?    @unique
  paradaReferencia   ParadaReferencia? @relation(fields: [paradaReferenciaId], references: [id])
  
  // Derrotero al que pertenece
  derroteroId     String
  derrotero       Derrotero     @relation(fields: [derroteroId], references: [id])
  
  // Checador asignado actualmente
  checadorId      String?
  checador        Checador?     @relation(fields: [checadorId], references: [id])
  
  // Configuración
  horaInicio      String?       // "06:00"
  horaFin         String?       // "21:00"
  activo          Boolean       @default(true)
  
  // Check-ins en este punto
  checkIns        CheckIn[]
  
  // Auditoría
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([derroteroId])
  @@index([checadorId])
  @@map("puntos_control")
}

// ===========================================
// PARADAS DE REFERENCIA (CDMX WiFi / datos abiertos)
// ===========================================
// Catálogo de ubicaciones tipo parada desde fuentes externas (ej. WiFi transporte CDMX).
// Sirve para enriquecer PuntoControl con coordenadas y para mapas/reportes.
//

model ParadaReferencia {
  id              String         @id @default(cuid())
  idExterno       String         @unique  // ID del dataset origen (ej. CETRAM_BALBUENA_AP_01)
  nombre          String         // Nombre legible o derivado del id
  latitud         Decimal        @db.Decimal(10, 8)
  longitud        Decimal        @db.Decimal(11, 8)
  alcaldia        String?
  programa        String?        // Ej. "Transporte (Metrobus, Cablebus...)"
  
  // Un PuntoControl puede vincularse a una parada de referencia
  puntoControl    PuntoControl?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([alcaldia])
  @@map("paradas_referencia")
}

// ===========================================
// VEHÍCULOS
// ===========================================

model Vehiculo {
  id              String          @id @default(cuid())
  placa           String          @unique
  numeroEconomico String?         // Número interno de la empresa
  tipo            TipoVehiculo
  estado          EstadoVehiculo  @default(ACTIVO)
  
  // Empresa y derrotero
  empresaId       String
  empresa         Empresa         @relation(fields: [empresaId], references: [id])
  derroteroId     String?
  derrotero       Derrotero?      @relation(fields: [derroteroId], references: [id])
  
  // Chofer asignado actualmente (asignación de flota)
  choferId        String?
  chofer          Chofer?         @relation("ChoferAsignado", fields: [choferId], references: [id])
  
  // Información del vehículo
  marca           String?
  modelo          String?
  anio            Int?
  capacidad       Int?            // Número de pasajeros
  
  // Chofer que tiene esta unidad "activada" (la está manejando ahora)
  choferActivo    Chofer?         @relation("UnidadActiva")

  // Check-ins de este vehículo
  checkIns        CheckIn[]
  registrosRutaChofer RegistroRutaChofer[]
  registrosUnidad RegistroUnidad[]

  // Auditoría
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([empresaId])
  @@index([derroteroId])
  @@index([choferId])
  @@map("vehiculos")
}

// ===========================================
// CHOFER (Extensión de User)
// ===========================================
// Un chofer puede trabajar en DIFERENTES empresas: se asigna a Vehículos,
// y cada Vehículo pertenece a una Empresa/Derrotero. No hay empresaId aquí;
// el ámbito es la unión de las empresas de sus vehículos asignados.
//

model Chofer {
  id              String       @id @default(cuid())
  
  // Usuario asociado
  userId          String       @unique
  user            User         @relation(fields: [userId], references: [id])
  
  // Licencia
  licencia        String?
  tipoLicencia    String?      // A, B, C, D, E
  vigenciaLicencia DateTime?
  
  // Vehículos asignados (pueden ser de distintas empresas/derroteros)
  vehiculos       Vehiculo[]      @relation("ChoferAsignado")
  
  // Unidad actualmente "activada" (la que está manejando ahora). Al terminar, se libera para otro chofer.
  vehiculoActivoId String?       @unique
  vehiculoActivo   Vehiculo?     @relation("UnidadActiva", fields: [vehiculoActivoId], references: [id])
  
  // Check-ins realizados
  checkIns        CheckIn[]
  
  // Registros fin de ruta (ingresos y gastos)
  registrosRuta   RegistroRutaChofer[]
  registrosUnidad RegistroUnidad[]

  // Pagos realizados
  pagos           Pago[]
  
  // Estadísticas
  totalCheckIns   Int          @default(0)
  
  // Auditoría
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("choferes")
}

// ===========================================
// REGISTRO ESTADÍSTICAS UNIDAD (km, servicios, deterioros)
// Compartido entre admin y chofer de la unidad.
// ===========================================
model RegistroUnidad {
  id              String             @id @default(cuid())
  vehiculoId      String
  vehiculo        Vehiculo           @relation(fields: [vehiculoId], references: [id], onDelete: Cascade)
  choferId        String?            // Quien registró (chofer o null si admin)
  chofer          Chofer?            @relation(fields: [choferId], references: [id])
  tipo            TipoRegistroUnidad // KM | SERVICIO | DETERIORO
  valorNumerico   Decimal?           // Para KM: kilometraje
  descripcion     String?            // Para SERVICIO/DETERIORO: detalle
  fecha           DateTime           @default(now())
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([vehiculoId])
  @@index([choferId])
  @@index([fecha])
  @@map("registros_unidad")
}

// ===========================================
// REGISTRO FIN DE RUTA (ingresos/egresos chofer)
// ===========================================
model RegistroRutaChofer {
  id              String    @id @default(cuid())
  choferId        String
  chofer          Chofer    @relation(fields: [choferId], references: [id], onDelete: Cascade)
  vehiculoId      String?
  vehiculo        Vehiculo? @relation(fields: [vehiculoId], references: [id])
  derroteroId     String?
  derrotero       Derrotero? @relation(fields: [derroteroId], references: [id])
  
  fecha           DateTime  @default(now())
  ingresos        Decimal   @default(0) @db.Decimal(10, 2)
  gastos          Decimal   @default(0) @db.Decimal(10, 2)
  notas           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([choferId])
  @@index([fecha])
  @@map("registros_ruta_chofer")
}

// ===========================================
// SUSCRIPCIÓN A RUTA (pasajero / usuario transporte)
// ===========================================
model SuscripcionRuta {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  derroteroId     String
  derrotero       Derrotero  @relation(fields: [derroteroId], references: [id], onDelete: Cascade)
  notificaciones  Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, derroteroId])
  @@index([userId])
  @@index([derroteroId])
  @@map("suscripciones_ruta")
}

// ===========================================
// CHECADOR (Extensión de User)
// ===========================================
// Un checador puede trabajar en DIFERENTES empresas/derroteros: se asigna
// a Puntos de control, y cada Punto pertenece a un Derrotero (Empresa).
// El ámbito es la unión de las empresas de sus puntos asignados.
//

model Checador {
  id              String         @id @default(cuid())
  
  // Usuario asociado
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id])
  
  // Identificación
  curp            String?
  ine             String?
  
  // Puntos de control asignados (pueden ser de distintos derroteros/empresas)
  puntosControl   PuntoControl[]
  
  // Check-ins registrados
  checkIns        CheckIn[]
  
  // Pagos recibidos (incentivos)
  pagosRecibidos  Pago[]
  
  // Estadísticas
  totalCheckIns   Int            @default(0)
  ingresoMes      Decimal        @default(0) @db.Decimal(10, 2)
  
  // Auditoría
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("checadores")
}

// ===========================================
// CHECK-INS (Registro de llegadas)
// ===========================================

model CheckIn {
  id              String          @id @default(cuid())
  
  // Quién lo registró y quién llegó (opcional si no hay checador/chofer asignado)
  checadorId      String?
  checador        Checador?       @relation(fields: [checadorId], references: [id])
  choferId        String?
  chofer          Chofer?         @relation(fields: [choferId], references: [id])
  
  // Dónde y qué vehículo
  puntoControlId  String
  puntoControl    PuntoControl    @relation(fields: [puntoControlId], references: [id])
  vehiculoId      String
  vehiculo        Vehiculo        @relation(fields: [vehiculoId], references: [id])
  
  // Datos del check-in
  fechaHora       DateTime        @default(now())
  tiempoTranscurrido Int?         // Minutos desde el último paso
  
  // Ubicación GPS (del checador al momento)
  latitud         Decimal?        @db.Decimal(10, 8)
  longitud        Decimal?        @db.Decimal(11, 8)
  
  // Estado y pago
  estado          EstadoCheckIn   @default(PENDIENTE)
  monto           Decimal         @default(15) @db.Decimal(10, 2) // $15 MXN
  
  // Notas
  notas           String?
  
  // Pago asociado
  pagoId          String?
  pago            Pago?           @relation(fields: [pagoId], references: [id])
  
  // Auditoría
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([checadorId])
  @@index([choferId])
  @@index([puntoControlId])
  @@index([vehiculoId])
  @@index([fechaHora])
  @@map("check_ins")
}

// ===========================================
// PAGOS
// ===========================================

model Pago {
  id              String        @id @default(cuid())
  
  // Tipo y monto
  tipo            TipoPago
  monto           Decimal       @db.Decimal(10, 2)
  estado          EstadoPago    @default(PENDIENTE)
  
  // Quién paga
  empresaId       String?
  empresa         Empresa?      @relation(fields: [empresaId], references: [id])
  choferId        String?
  chofer          Chofer?       @relation(fields: [choferId], references: [id])
  
  // Quién recibe (checador)
  checadorId      String?
  checador        Checador?     @relation(fields: [checadorId], references: [id])
  
  // Check-ins asociados (si es pago de check-in)
  checkIns        CheckIn[]
  
  // Método de pago
  metodoPago      String?       // "efectivo", "transferencia", "stripe"
  referencia      String?       // Referencia de transacción
  
  // Fechas
  fechaPago       DateTime?
  
  // Notas
  notas           String?
  
  // Auditoría
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([empresaId])
  @@index([choferId])
  @@index([checadorId])
  @@index([tipo])
  @@index([estado])
  @@map("pagos")
}

// ===========================================
// REGISTRO DE ACTIVIDAD (AUDIT LOG)
// ===========================================
// Para desarrollo y para Super Admin / Admin Empresa: ver qué hacen sus usuarios.
model AuditLog {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  // Quién (opcional si es fallo de login)
  userId      String?
  userEmail   String?
  userNombre  String?
  role        String?  // Role del usuario al momento del evento
  empresaId   String?  // Para filtrar por empresa (Admin Empresa)

  // Qué pasó
  accion      String   // LOGIN, LOGIN_FAIL, CHECKIN_CREATE, USER_CREATE, etc.
  recurso     String?  // "check_in", "user", "auth"
  recursoId   String?

  // Detalles extra (JSON): placa, puntoControl, etc.
  detalles    Json?

  // Request (opcional)
  ip          String?
  userAgent   String?

  @@index([createdAt])
  @@index([userId])
  @@index([empresaId])
  @@index([accion])
  @@map("audit_logs")
}

// ===========================================
// CONFIGURACIÓN DEL SISTEMA
// ===========================================

model ConfiguracionSistema {
  id              String    @id @default(cuid())
  clave           String    @unique
  valor           String
  descripcion     String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("configuracion_sistema")
}
